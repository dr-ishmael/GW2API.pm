=pod

=head1 NAME

GuildWars2::API - An interface library for the Guild Wars 2 API

=head1 SYNOPSIS

 use GuildWars2::API;

 $api = GuildWars2::API->new();

 # Check the current state of an event on all worlds

 %event_states = $api->event_state_by_world($event_id);

 foreach my $world_id (keys %event_states) {
     my $state = $event_states{$world_id};

     print "$world_id : $state\n";
 }

 # Lookup the attribute bonuses on a weapon

 %item_details = $api->item_details($item_id);

 $attributes_ref = %item_details{weapon}->{attributes};

 foreach $attribute (@$attributes_ref) {
     ($attr_name, $attr_value) =
          ($attribute->{attribute}, $attribute->{modifier});

     print "+$attr_value $attr_name\n";
 }

=head1 DESCRIPTION

GuildWars2::API is a class module that provides a set of standard interfaces to
the L<Guild Wars 2 API|http://wiki.guildwars2.com/wiki/API:Main>.

=head1 Constructor

=over

=item $api = GuildWars2::API->new
=item $api = GuildWars2::API->new( key => value, ... )

This method constructs a new C<GuildWars2::API> object and returns it. Key/value
pairs of configuration options may be provided, which then become class
attributes.

Each of the attributes can be accessed via an eponymous class method. Most can
also be assigned new values in this manner, although a few attributes are
designated read-only.

 my $api = GuildWars2::API->new( timeout => 60 );

 print $api->timeout;   # 60

 $api->timeout(180);

 print $api->timeout;   # 180

=over

=item timeout [INT]

The length of time, in seconds, to wait for a response from the API. Defaults to
30.

=item retries [INT]

The number of times to attempt an API request before dying. Defaults to 3.

=item language [STRING]

The language code to use for all API requests. Defaults to 'en', other
supported languages are 'de', 'es', and 'fr'. This setting can be overridden
when calling individual API methods.

=item nocache [BOOL]

I<Read-only>. Disable local caching of API responses. Defaults to undef. Using this in
combination with any of the following cache options will cause an error.

=item cache_dir [STRING]

I<Read-only>. The local directory to use as the cache location. Defaults to './gw2api-cache'
and will attempt to create the directory if it does not exist.

=item cache_age [DURATION]

Length of time after which the cached responses will expire. Defaults to '24
hours'. Accepted values are strings consisting of an integer followed by a time
unit, e.g. '1 day' or '10 seconds' etc.

This applies to I<most> of the APIs; the following *_cache_age parameters
override this setting for specific APIs.

=item event_cache_age [DURATION]

Length of time after which the cached version of I<event state> responses will
expire. Defaults to '30 seconds'.

=item wvw_cache_age [DURATION]

Length of time after which the cached version of I<WvW match detail> responses
will expire. Defaults to '5 minutes'.

=back

=back

=head2 Subclassed objects

The following classes are loaded into the GuildWars2::API class and can be
accessed as "subobjects" of the main C<$api> object.

=over

=item L<CHI> - $api->cache

Interface to the file cache handler. Used for storing API responses locally.

=item L<JSON::PP> - $api->json

Interface for encoding/decoding JSON strings. Used to decode the JSON responses
from the API.

=item L<LWP::UserAgent> - $api->ua

HTTP interface. Used for interacting with the API.

=back

=head1 Methods

=over

=item $api->build

Returns the current Guild Wars 2 build number. Useful for tracking when a game
update is released, since the build number will change.

=item $api->event_names
=item $api->event_names( $lang )

=item $api->map_names
=item $api->map_names( $lang )

=item $api->world_names
=item $api->world_names( $lang )

=item $api->objective_names
=item $api->objective_names( $lang )

Each of these methods returns a hash, keyed by the event/map/etc. ID, containing
the names corresponding to those IDs. Pass a language code as an argument to
override the current default language.

=item $api->event_state( $event_id, $world_id )

Returns a string containing the current state of a specific event on a specific
world. Event state will be one of the following values (definitions are from
L<the official API documentation|http://wiki.guildwars2.com/wiki/API:1/events>):

 State        Meaning
 ------------ ---------------------------------------------------------
 Active       The event is running now.
 Inactive     The event is not running now.
 Success      The event has succeeded.
 Fail         The event has failed.
 Warmup       The event is inactive, and will only become active once
              certain criteria are met.
 Preparation  The criteria for the event to start have been met, but
              certain activities (such as an NPC dialogue) have not
              completed yet. After the activites have been completed,
              the event will become Active.

=item $api->event_state_by_world( $event_id )

Returns a hash, keyed by world ID, containing the current state of the given
event on each world.

=item $api->event_states_in_map( $map_id, $world_id )

Returns a hash, keyed by event ID, containing the current state of all events
occurring within a specific map on a specific world.

=item $api->wvw_matches

Returns an array containing basic information on the current WvW matches. Each
array element is a hash with the following structure:

 (
   wvw_match_id   => [STR],     # Match ID
   red_world_id   => [INT],     # World ID of the red world
   blue_world_id  => [INT],     # World ID of the blue world
   green_world_id => [INT],     # World ID of the green world
   start_time     => [STRING],  # Date/time that current match started (UTC)
   end_time       => [STRING],  # Date/time that current match ended (UTC)
 )

=item $api->wvw_match_details( $match_id )

Returns a hash containing detailed information on a specific WvW match. The hash
has the following structure:

 (
   match_id   => [STRING],  # Match ID
   scores     =>
     [
       [INT],               # Red world total score
       [INT],               # Green world total score
       [INT]                # Blue world total score
     ],
   maps       =>            # Array of map data
     [
       {
         type       => [STRING],  # Map type (RedHome, GreenHome, BlueHome, Center)
         scores     =>
           [
             [INT],               # Red world map score
             [INT],               # Green world map score
             [INT]                # Blue world map score
           ],
         objectives =>            # Array of objectives in the map
           [
             {
               id          => [INT],    # Objective ID
               owner       => [STRING], # Current owner of the objective (Red, Blue, Green)
               owner_guild => [STRING], # Guild ID that has claimed the objective
                                        #   (only present if objective has been claimed)
             },
             ...                  # Repeat for all objectives in the map
           ]
       },
       ...                  # Repeat for each of 4 maps
     ],
 )

=item $api->list_items

Returns an array containing all "discovered" item IDs.

=item $api->get_item( $item_id )
=item $api->get_item( $item_id, $lang )

Retrieves data for the given item_id (in the given language or the current
default) and returns a GuildWars2::API::Objects::Item object.

=item $api->list_recipes

Returns an array containing all "discovered" recipe IDs.

=item $api->get_recipe( $recipe_id )
=item $api->get_recipe( $recipe_id, $lang )

Retrieves data for the given recipe_id (in the given language or the current
default) and returns a GuildWars2::API::Objects::Recipe object.

=item $api->get_colors
=item $api->get_colors( $lang )

Returns a hash, keyed on color_id, containing color information for all colors
in the game. Each hash element is a GuildWars2::API::Objects::Color object.

=item $api->get_guild( $guild_id )
=item $api->get_guild( $guild_name )

Retrieves data for the given guild ID or guild name and returns a
GuildWars2::API::Objects::Guild object. If the argument doesn't match the
pattern of a guild ID, it is assumed to be a guild name.

=item $api->get_maps
=item $api->get_maps( $continent_id, $floor_id, $lang )

Retreives a hash, keyed on region_id, containing map information on the world
of Tyria. Each has element is a GuildWars2::API::Objects::Region object.

=back

=head1 Author

Tony Tauer, E<lt>dr.ishmael[at]gmail.comE<gt>

=head1 COPYRIGHT AND LICENSE

Copyright 2013 by Tony Tauer

This library is free software; you can redistribute it and/or modify it under
the same terms as Perl itself.

=cut
